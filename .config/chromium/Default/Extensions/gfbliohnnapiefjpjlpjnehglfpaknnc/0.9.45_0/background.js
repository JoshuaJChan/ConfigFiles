"use strict";function loadRawSettings(e,t,n){var o=n||{};chrome.storage.local.get(null,function(n){var r=n.savedAt||0;chrome.storage.sync.get(null,function(i){var a=i.savedAt||0;r>a?(extendObject(o,n),_save(chrome.storage.sync,n,function(){var n=getSubSettings(o,e);chrome.runtime.lastError&&(n.error="Settings sync may not work thoroughly because of: "+chrome.runtime.lastError.message),t(n)})):r<a?(extendObject(o,i),t(getSubSettings(o,e)),_save(chrome.storage.local,i)):(extendObject(o,n),t(getSubSettings(o,e)))})})}function _applyProxySettings(e){if(e.proxyMode&&"clear"!==e.proxyMode){var t=e.autoproxy_hosts.map(function(e){return e.filter(function(e){return e.indexOf("*")!==-1}).join("|")}),n=e.autoproxy_hosts.map(function(e){return dictFromArray(e.filter(function(e){return e.indexOf("*")===-1}),1)}),o={mode:["always","byhost","bypass"].indexOf(e.proxyMode)!==-1?"pac_script":e.proxyMode,pacScript:{data:"var pacGlobal = {\n                        hosts: "+JSON.stringify(n)+",\n                        autoproxy_pattern: "+JSON.stringify(t)+",\n                        proxyMode: '"+e.proxyMode+"',\n                        proxy: "+JSON.stringify(e.proxy)+'\n                    };\n                    function FindProxyForURL(url, host) {\n                        var lastPos;\n                        if (pacGlobal.proxyMode === "always") {\n                            return pacGlobal.proxy[0];\n                        } else if (pacGlobal.proxyMode === "bypass") {\n                            var pp = new RegExp(pacGlobal.autoproxy_pattern[0]);\n                            do {\n                                if (pacGlobal.hosts[0].hasOwnProperty(host)\n                                    || (pacGlobal.autoproxy_pattern[0].length && pp.test(host))) {\n                                    return "DIRECT";\n                                }\n                                lastPos = host.indexOf(\'.\') + 1;\n                                host = host.slice(lastPos);\n                            } while (lastPos >= 1);\n                            return pacGlobal.proxy[0];\n                        } else {\n                            for (var i = 0; i < pacGlobal.proxy.length; i++) {\n                                var pp = new RegExp(pacGlobal.autoproxy_pattern[i]);\n                                var ahost = host;\n                                do {\n                                    if (pacGlobal.hosts[i].hasOwnProperty(ahost)\n                                        || (pacGlobal.autoproxy_pattern[i].length && pp.test(ahost))) {\n                                        return pacGlobal.proxy[i];\n                                    }\n                                    lastPos = ahost.indexOf(\'.\') + 1;\n                                    ahost = ahost.slice(lastPos);\n                                } while (lastPos >= 1);\n                            }\n                            return "DIRECT";\n                        }\n                    }'}};chrome.proxy.settings.set({value:o,scope:"regular"},function(){})}else chrome.proxy.settings.clear({scope:"regular"})}function request(e,t,n,o,r){return n=n||{},new Promise(function(t,r){var i=new XMLHttpRequest,a=void 0!==o?"POST":"GET";i.open(a,e);for(var s in n)i.setRequestHeader(s,n[s]);i.onload=function(){t(i.responseText)},i.onerror=r.bind(null,i),i.send(o)}).then(t)["catch"](function(e){r&&r(e)})}function dictFromArray(e,t){var n={};return e.forEach(function(e){n[e]=t}),n}function extendObject(e,t){for(var n in t)e[n]=t[n]}function getSubSettings(e,t){var n;return t?(t instanceof Array||(t=[t]),n={},t.forEach(function(t){n[t]=e[t]})):n=e,n}function _save(e,t,n){t.localPath&&delete t.snippets,e.set(t,n)}var Gist=function(){function e(e,t,n){request("https://api.github.com/gists",function(o){var r=JSON.parse(o),i="";r.forEach(function(e){e.hasOwnProperty("description")&&e.description===t&&e.files.hasOwnProperty(t)&&(i=e.id)}),""===i?request("https://api.github.com/gists",function(e){var t=JSON.parse(e);n(t.id)},{Authorization:"token "+e},'{ "description": "'+t+'", "public": false, "files": { "'+t+'": { "content": "'+t+'" } } }'):n(i)},{Authorization:"token "+e})}function t(e,t){request("https://api.github.com/gists/"+s+"/comments",function(e){t&&t(e)},{Authorization:"token "+i},'{"body": "'+encodeURIComponent(e)+'"}')}function n(e,t){request("https://api.github.com/gists/"+s+"/comments/"+e,function(e){var n=JSON.parse(e);t({status:0,content:decodeURIComponent(n.body)})},{Authorization:"token "+i})}function o(e){request("https://api.github.com/gists/"+s+"/comments",function(t){c=JSON.parse(t).map(function(e){return e.id}),e(c)},{Authorization:"token "+i})}function r(e,t,n){request("https://api.github.com/gists/"+s+"/comments/"+e,function(e){n&&n(e)},{Authorization:"token "+i},'{"body": "'+encodeURIComponent(t)+'"}')}var i,a={},s="",c=[];return a.initGist=function(t,n){i===t&&""!==s?n&&n(s):(i=t,e(i,"cloudboard",function(e){s=e,n&&n(s)}))},a.readComment=function(e,t){""===s?t({status:1,content:"Please call initGist first!"}):e>=c.length?o(function(o){e<o.length?n(o[e],t):t({status:1,content:"Register not exists!"})}):n(c[e],t)},a.editComment=function(e,n,i){""===s?i({status:1,content:"Please call initGist first!"}):e>=c.length?o(function(o){if(e<o.length)r(o[e],n,i);else{var a=function c(){s--,s>0?t(".",c):0===s&&t(n,i)},s=e-o.length+1;a()}}):r(c[e],n,i)},a}(),ChromeService=function(){function e(t,n){var o=n;if(""===t.title||t.hasOwnProperty("url")&&void 0!==t.url||(o+="/"+t.title,F.push({id:t.id,title:o+"/"})),t.hasOwnProperty("children"))for(var r=0;r<t.children.length;++r)e(t.children[r],o)}function t(e,n){e.path.length?chrome.bookmarks.create({parentId:e.folder,title:e.path.shift()},function(o){e.folder=o.id,t(e,n)}):chrome.bookmarks.create({parentId:e.folder,title:e.title,url:e.url},function(e){n(e)})}function n(e,t,n,o){if(e&&"content_runtime"!==e.target)if(q.hasOwnProperty(e.action)){e.repeats>G.repeatThreshold&&(e.repeats=G.repeatThreshold);try{q[e.action](e,t,n)}catch(r){console.log(e.action+": "+r)}}else{var i=o?"[unexpected port message] ":"[unexpected runtime message] ";console.log(i+JSON.stringify(e))}}function o(e,t){var n={blacklist:{},marks:{},findHistory:[],cmdHistory:[],sessions:{},proxyMode:"clear",autoproxy_hosts:[],proxy:[]};loadRawSettings(e,function(e){"string"==typeof e.proxy&&(e.proxy=[e.proxy],e.autoproxy_hosts=[e.autoproxy_hosts]),e.localPath?request(e.localPath,function(n){e.snippets=n,t(e)},void 0,void 0,function(n){e.error="Failed to read snippets from "+e.localPath,t(e)}):t(e)},n)}function r(e){delete _[e],delete E[e],delete A[e],delete M[e],delete U[e],R=R.filter(function(t){return t!==e}),H.length&&chrome.tabs.create({active:!1,url:H.shift()}),u()}function i(e){if(E.hasOwnProperty(e)){var t=E[e];chrome.tabs.executeScript(e,{code:"_setScrollPos("+t.scrollLeft+", "+t.scrollTop+")"}),delete E[e]}}function a(e,t,n){n.action=e.action,n.id=e.id,t(n)}function s(e,t){e.savedAt=(new Date).getTime(),_save(chrome.storage.local,e,function(){t&&t()}),_save(chrome.storage.sync,e,function(){if(chrome.runtime.lastError){chrome.runtime.lastError.message}})}function c(e,t){I.forEach(function(t){t.postMessage({action:"settingsUpdated",settings:e})}),s(e,t)}function u(){G.showTabIndices&&chrome.tabs.query({currentWindow:!0},function(e){e.forEach(function(e){chrome.tabs.sendMessage(e.id,{subject:"tabIndexChange",target:"content_runtime",index:e.index+1})})})}function l(e,t,n){if(e.blacklist[".*"])return!0;if(t){if(e.blacklist[t.origin])return!0;if(n)return n=new RegExp(n.source,n.flags),n.test(t.href)}return!1}function d(e,t){request(e,function(n){c({localPath:e,snippets:n}),t({status:"Succeeded",snippets:n})},void 0,void 0,function(e){t({status:"Failed"})})}function f(e,t){return t&&t.length&&(e=e.filter(function(e){return e.title.indexOf(t)!==-1||e.url&&e.url.indexOf(t)!==-1})),e}function h(e,t){chrome.history.search({startTime:0,maxResults:2147483647,text:""},function(n){t&&(n=n.sort(function(e,t){return t.visitCount-e.visitCount})),e(n)})}function p(e,t){return e<0?e=0:e>=t&&(e=t),e}function m(e,t,n){return t>n-e&&(e-=t-(n-e)),e}function b(e,t){chrome.tabs.query({windowId:e.windowId},function(n){0==e.index&&t==-1?t=n.length-1:e.index==n.length-1&&1==t&&(t=1-n.length);var o=p(e.index+t,n.length-1);chrome.tabs.update(n[o].id,{active:!0})})}function g(e,t,n){chrome.tabs.query({windowId:e.windowId},function(o){var r=o.map(function(e){return e.id});t=p(t,o.length);var i=m(e.index,t,o.length);n(r.slice(i,i+t))})}function y(e,t){chrome.tabs.query({currentWindow:!0},function(n){n=n.map(function(e){return e.id}),chrome.tabs.remove(n.slice(e.tab.index+(t<0?t:1),e.tab.index+(t<0?0:1+t)))})}function v(e){return!/^view-source:|^javascript:/.test(e)&&/^(?:https?:\/\/)?(?:[^@\/\n]+@)?(?:www\.)?([^:\/\n]+)/im.test(e)&&(e=/^[\w-]+?:/i.test(e)?e:"http://"+e),e}function w(){chrome.windows.getAll({populate:!1},function(e){e.forEach(function(e){chrome.windows.remove(e.id)})})}function x(e,t){o(["proxyMode","proxy","autoproxy_hosts"],function(n){if("deleteProxyPair"===e.operation)n.proxy.splice(e.number,1),n.autoproxy_hosts.splice(e.number,1);else if("set"===e.operation)n.proxyMode=e.mode,n.proxy=e.proxy,n.autoproxy_hosts=e.host;else if(e.mode&&(n.proxyMode=e.mode),e.number||(e.number=0),e.proxy&&(n.proxy[e.number]=e.proxy,n.autoproxy_hosts.length<=e.number&&(n.autoproxy_hosts[e.number]=[])),e.host){var o=dictFromArray(n.autoproxy_hosts[e.number],1),r=e.host.split(/\s*[ ,\n]\s*/);"toggle"===e.operation?r.forEach(function(e){o.hasOwnProperty(e)?delete o[e]:o[e]=1}):"add"===e.operation?r.forEach(function(e){o[e]=1}):r.forEach(function(e){delete o[e]}),n.autoproxy_hosts[e.number]=Object.keys(o)}var i={autoproxy_hosts:n.autoproxy_hosts,proxyMode:n.proxyMode,proxy:n.proxy};c(i),_applyProxySettings(n),t&&t(i)})}function k(e,t){var n=e[0],e=e.substr(1);"B"===n?chrome.bookmarks.remove(e,t):"H"===n?chrome.history.deleteUrl({url:e},t):"T"===n?(e=e.split(":").map(function(e){return parseInt(e)}),chrome.windows.update(e[0],{focused:!0},function(){chrome.tabs.remove(e[1],t)})):"M"===n&&o("marks",function(n){delete n.marks[e],c({marks:n.marks},t)})}function T(e,t){chrome.bookmarks.search({url:e},function(e){e.forEach(function(e){chrome.bookmarks.remove(e.id)}),t&&t()})}function O(e){for(var t=0;t<e.requestHeaders.length;++t)if("User-Agent"===e.requestHeaders[t].name){e.requestHeaders[t].value=D;break}return{requestHeaders:e.requestHeaders}}var q={},I=[],R=[],S=0,L=0,P=!1,_={},E={},U={},A={},M={},C="chrome://newtab/",G={focusAfterClosed:"right",repeatThreshold:99,tabsMRUOrder:!0,newTabPosition:"default",showTabIndices:!1,interceptedErrors:[]},F=[];o(null,_applyProxySettings),chrome.webRequest.onErrorOccurred.addListener(function(e){o("blacklist",function(t){var n=["net::ERR_ABORTED","net::ERR_CERT_AUTHORITY_INVALID"],o=e.tabId,r=l(t,new URL(e.url),null);r||o===-1||G.interceptedErrors.indexOf("*")===-1&&G.interceptedErrors.indexOf(e.error)===-1||(M.hasOwnProperty(o)||(M[o]=[]),"main_frame"===e.type&&(M[o]=[],n.indexOf(e.error)===-1&&chrome.tabs.update(o,{url:chrome.extension.getURL("pages/error.html")})),M[o].push(e))})},{urls:["<all_urls>"]}),chrome.runtime.onConnect.addListener(function(e){e.sender;I.push(e),e.onMessage.addListener(function(e,t){return n(e,t.sender,function(n){try{t.isDisconnected||t.postMessage(n)}catch(o){console.log(e.action+": "+o),console.log(t)}},t)}),e.onDisconnect.addListener(function(){e.isDisconnected=!0;for(var t=0;t<I.length;t++)if(I[t]===e){I.splice(t,1);break}})}),chrome.tabs.onRemoved.addListener(r),chrome.tabs.onUpdated.addListener(function(e,t,n){"loading"===t.status&&delete U[e],i(e)}),chrome.tabs.onCreated.addListener(function(e){i(e.id),u()}),chrome.tabs.onMoved.addListener(function(){u()}),chrome.tabs.onActivated.addListener(function(e){A.hasOwnProperty(e.tabId)&&!P&&e.tabId!=R[R.length-1]&&(R.length>10&&R.shift(),S!=R.length-1&&R.splice(S+1,R.length-1),R.push(e.tabId),S=R.length-1),_[e.tabId]=(new Date).getTime(),P=!1,L=0,i(e.tabId),u()}),chrome.tabs.onDetached.addListener(function(){u()}),chrome.tabs.onAttached.addListener(function(){u()}),chrome.commands.onCommand.addListener(function(e){switch(e){case"restartext":chrome.runtime.reload();break;case"previousTab":case"nextTab":chrome.tabs.query({active:!0,currentWindow:!0},function(t){var n=t[0],o="previousTab"===e?n.index-1:n.index+1;chrome.tabs.query({windowId:n.windowId},function(e){o=(o%e.length+e.length)%e.length,chrome.tabs.update(e[o].id,{active:!0})})});break;case"closeTab":chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.remove(e[0].id)});break;case"proxyThis":chrome.tabs.query({currentWindow:!0,active:!0},function(e){var t=new URL(e[0].url).host;x({host:t,operation:"toggle"},function(){chrome.tabs.reload(e[0].id,{bypassCache:!0})})})}}),chrome.runtime.onMessage.addListener(n),q.getTabErrors=function(e,t,n){a(e,n,{tabError:M[t.tab.id]})},q.clearTabErrors=function(e,t,n){M[t.tab.id]=[]},q.isTabActive=function(e,t,n){chrome.tabs.query({active:!0},function(o){var r=o.map(function(e){return e.id});a(e,n,{active:r.indexOf(t.tab.id)!==-1})})},q.toggleBlacklist=function(e,t,n){o("blacklist",function(o){var r=".*";t.tab&&0!==t.tab.url.indexOf(chrome.extension.getURL(""))&&(r=new URL(t.tab.url).origin),o.blacklist.hasOwnProperty(r)?delete o.blacklist[r]:o.blacklist[r]=1,c({blacklist:o.blacklist},function(){a(e,n,{disabled:l(o,t.tab?new URL(t.tab.url):null,e.blacklistPattern),blacklist:o.blacklist,url:r})})})},q.toggleMouseQuery=function(e,t,n){o("mouseSelectToQuery",function(n){if(t.tab&&0!==t.tab.url.indexOf(chrome.extension.getURL(""))){var o=n.mouseSelectToQuery||[],r=o.indexOf(e.origin);r===-1?o.push(e.origin):o.splice(r,1),c({mouseSelectToQuery:o})}})},q.getDisabled=function(e,t,n){o("blacklist",function(o){t.tab&&a(e,n,{disabled:l(o,new URL(t.tab.url),e.blacklistPattern)})})},q.addVIMark=function(e,t,n){o("marks",function(t){extendObject(t.marks,e.mark),c({marks:t.marks})})},q.jumpVIMark=function(e,t,n){o("marks",function(o){var r=o.marks;if(r.hasOwnProperty(e.mark)){var a=r[e.mark];chrome.tabs.query({},function(e){e=e.filter(function(e){return e.url===a.url}),0===e.length?(a.tab={tabbed:!0,active:!0},q.openLink(a,t,n)):((a.scrollLeft||a.scrollTop)&&(E[e[0].id]={scrollLeft:a.scrollLeft,scrollTop:a.scrollTop}),e[0].id===t.tab.id?i(e[0].id):chrome.tabs.update(e[0].id,{active:!0}))})}})},q.resetSettings=function(e,t,n){chrome.storage.local.clear(),chrome.storage.sync.clear(),o(null,function(t){_applyProxySettings(t),a(e,n,{settings:t}),I.forEach(function(e){e.postMessage({action:"settingsUpdated",settings:t})})})},q.loadSettingsFromUrl=function(e,t,n){d(e.url,function(t){a(e,n,t)})},q.getRecentlyClosed=function(e,t,n){chrome.sessions.getRecentlyClosed({},function(t){for(var o=[],r=0;r<t.length;r++){var i=t[r];i.hasOwnProperty("window")?o=o.concat(i.window.tabs):i.hasOwnProperty("tab")&&o.push(i.tab)}o=f(o,e.query),a(e,n,{urls:o})})},q.getTopSites=function(e,t,n){chrome.topSites.get(function(t){t=f(t,e.query),a(e,n,{urls:t})})},q.getAllURLs=function(e,t,n){chrome.bookmarks.getRecent(2147483647,function(t){var o=t;h(function(t){o=o.concat(t),a(e,n,{urls:o})},!0)})},q.getTabs=function(e,t,n){var o=t.tab,r=e.queryInfo||{};chrome.tabs.query(r,function(t){t=f(t,e.query),e.query&&e.query.length&&(t=t.filter(function(t){return t.title.indexOf(e.query)!==-1||t.url&&t.url.indexOf(e.query)!==-1})),t=t.filter(function(e){return e.id!==o.id}),G.tabsMRUOrder&&t.sort(function(e,t){var n=_[e.id],o=_[t.id];return isFinite(n)||isFinite(o)?isFinite(n)?isFinite(o)?o-n:-1:1:0}),a(e,n,{tabs:t})})},q.togglePinTab=function(e,t,n){chrome.tabs.query({currentWindow:!0,active:!0},function(e){var t=e[0];return chrome.tabs.update(t.id,{pinned:!t.pinned})})},q.focusTab=function(e,t,n){void 0!==e.window_id&&t.tab.windowId!==e.window_id?chrome.windows.update(e.window_id,{focused:!0},function(){chrome.tabs.update(e.tab_id,{active:!0})}):chrome.tabs.update(e.tab_id,{active:!0})},q.focusTabByIndex=function(e,t,n){var o=e.queryInfo||{};chrome.tabs.query(o,function(t){e.repeats>0&&e.repeats<=t.length&&chrome.tabs.update(t[e.repeats-1].id,{active:!0})})},q.goToLastTab=function(e,t,n){if(R.length>1){var o=R[R.length-2];chrome.tabs.update(o,{active:!0})}},q.historyTab=function(e,t,n){if(R.length>0){P=!0,e.hasOwnProperty("index")?S=(parseInt(e.index)+R.length)%R.length:(S+=e.backward?-1:1,S<0?S=0:S>=R.length&&(S=R.length-1));var o=R[S];chrome.tabs.update(o,{active:!0})}},q.nextTab=function(e,t,n){b(t.tab,e.repeats)},q.previousTab=function(e,t,n){b(t.tab,-e.repeats)},q.reloadTab=function(e,t,n){g(t.tab,e.repeats,function(t){t.forEach(function(t){chrome.tabs.reload(t,{bypassCache:e.nocache})})})},q.closeTab=function(e,t,n){g(t.tab,e.repeats,function(e){chrome.tabs.remove(e,function(){"left"===G.focusAfterClosed&&b(t.tab,-1)})})},q.closeTabLeft=function(e,t,n){y(t,-e.repeats)},q.closeTabRight=function(e,t,n){y(t,e.repeats)},q.closeTabsToLeft=function(e,t,n){y(t,-t.tab.index)},q.closeTabsToRight=function(e,t,n){chrome.tabs.query({currentWindow:!0},function(e){y(t,e.length-t.tab.index)})},q.tabOnly=function(e,t,n){chrome.tabs.query({currentWindow:!0},function(e){e=e.map(function(e){return e.id}).filter(function(e){return e!=t.tab.id}),chrome.tabs.remove(e)})},q.muteTab=function(e,t,n){var o=t.tab;chrome.tabs.update(o.id,{muted:!o.mutedInfo.muted})},q.openLast=function(e,t,n){chrome.sessions.restore()},q.duplicateTab=function(e,t,n){chrome.tabs.duplicate(t.tab.id)},q.newWindow=function(e,t,n){chrome.tabs.query({},function(e){var n={};if(e.forEach(function(e){n[e.windowId]=n[e.windowId]||[],n[e.windowId].push(e.id)}),n[t.tab.windowId]&&1===n[t.tab.windowId].length){var o,r=0;for(var i in n)n[i].length>r&&(r=n[i].length,o=i);chrome.tabs.move(t.tab.id,{windowId:parseInt(o),index:-1})}else chrome.windows.create({tabId:t.tab.id})})},q.getBookmarkFolders=function(t,n,o){chrome.bookmarks.getTree(function(n){F=[],e(n[0],""),a(t,o,{folders:F})})},q.createBookmark=function(e,n,o){T(e.page.url,function(){t(e.page,function(t){a(e,o,{bookmark:t})})})},q.getBookmarks=function(e,t,n){e.parentId?chrome.bookmarks.getSubTree(e.parentId,function(t){var o=t[0].children;e.query&&e.query.length&&(o=o.filter(function(t){return t.title.indexOf(e.query)!==-1||t.url&&t.url.indexOf(e.query)!==-1})),a(e,n,{bookmarks:o})}):e.query&&e.query.length?chrome.bookmarks.search(e.query,function(t){a(e,n,{bookmarks:t})}):chrome.bookmarks.getTree(function(t){a(e,n,{bookmarks:t[0].children})})},q.getHistory=function(e,t,n){h(function(t){a(e,n,{history:t})},e.sortByMostUsed)},q.openLink=function(e,t,n){var o=v(e.url);if(o.startsWith("javascript:"))chrome.tabs.executeScript(t.tab.id,{code:o.substr(11)});else if(e.tab.tabbed){var r;if(t.tab)switch(G.newTabPosition){case"left":r=t.tab.index;break;case"right":r=t.tab.index+1;break;case"first":r=0;break;case"last":break;default:r=t.tab.index+1+L,L++}chrome.tabs.create({url:o,active:e.tab.active,index:r,pinned:e.tab.pinned,openerTabId:t.tab.id},function(t){(e.scrollLeft||e.scrollTop)&&(E[t.id]={scrollLeft:e.scrollLeft,scrollTop:e.scrollTop})})}else chrome.tabs.update({url:o,pinned:e.tab.pinned||t.tab.pinned},function(t){(e.scrollLeft||e.scrollTop)&&(E[t.id]={scrollLeft:e.scrollLeft,scrollTop:e.scrollTop})})},q.viewSource=function(e,t,n){e.url="view-source:"+t.tab.url,q.openLink(e,t,n)},q.getSettings=function(e,t,n){var r=o;"RAW"===e.key&&(r=loadRawSettings,e.key=""),r(e.key,function(t){a(e,n,{settings:t})})},q.updateSettings=function(e,t,n){if("snippets"===e.scope)for(var o in e.settings)G.hasOwnProperty(o)&&(G[o]=e.settings[o]);else c(e.settings)},q.setSurfingkeysIcon=function(e,t,n){chrome.browserAction.setIcon({path:e.status?"icons/48-x.png":"icons/48.png",tabId:t.tab?t.tab.id:void 0})},q.request=function(e,t,n){request(e.url,function(t){a(e,n,{text:t})},e.headers,e.data)},q.nextFrame=function(e,t,n){var o=t.tab.id;chrome.tabs.executeScript(o,{allFrames:!0,code:"Front && Front.getFrameId && Front.getFrameId()"},function(e){e=e.filter(function(e){return e}),e.length>1&&(U.hasOwnProperty(o)||(U[o]=0),U[o]++,U[o]=U[o]%e.length,chrome.tabs.sendMessage(o,{subject:"focusFrame",target:"content_runtime",frameId:e[U[o]]}))})},q.moveTab=function(e,t,n){chrome.tabs.query({windowId:t.tab.windowId},function(n){var o=p(t.tab.index+e.step*e.repeats,n.length);chrome.tabs.move(t.tab.id,{index:o})})},q.quit=function(e,t,n){w()},q.createSession=function(e,t,n){o("sessions",function(t){chrome.tabs.query({},function(n){var o={};n.forEach(function(e){e&&void 0!==e.index&&(o.hasOwnProperty(e.windowId)||(o[e.windowId]=[]),e.url!==C&&o[e.windowId].push(e.url))});var r=[];for(var i in o)o[i].length&&r.push(o[i]);t.sessions[e.name]={},t.sessions[e.name].tabs=r,c({sessions:t.sessions},e.quitAfterSaved?w:void 0)})})},q.openSession=function(e,t,n){o("sessions",function(t){if(t.sessions.hasOwnProperty(e.name)){var n=t.sessions[e.name].tabs;n[0].forEach(function(e){chrome.tabs.create({url:e,active:!1,pinned:!1})});for(var o=1;o<n.length;o++){var r=n[o];chrome.windows.create({},function(e){r.forEach(function(t){chrome.tabs.create({windowId:e.id,url:t,active:!1,pinned:!1})})})}chrome.tabs.query({url:C},function(e){chrome.tabs.remove(e.map(function(e){return e.id}))})}})},q.deleteSession=function(e,t,n){o("sessions",function(t){delete t.sessions[e.name],c({sessions:t.sessions})})},q.closeDownloadsShelf=function(e,t,n){e.clearHistory?chrome.downloads.erase({urlRegex:".*"}):(chrome.downloads.setShelfEnabled(!1),chrome.downloads.setShelfEnabled(!0))},q.getDownloads=function(e,t,n){chrome.downloads.search(e.query,function(t){a(e,n,{downloads:t})})},q.executeScript=function(e,t,n){chrome.tabs.executeScript(t.tab.id,{frameId:t.frameId,code:e.code,matchAboutBlank:!0,file:e.file},function(t){a(e,n,{response:t})})},q.tabURLAccessed=function(e,t,n){if(t.tab){var o=t.tab.id;A.hasOwnProperty(o)||(A[o]={}),A[o][e.url]=e.title,a(e,n,{index:G.showTabIndices?t.tab.index+1:0})}},q.getTabURLs=function(e,t,n){var o=A[t.tab.id]||{};o=Object.keys(o).map(function(e){return{url:e,title:o[e]}}),a(e,n,{urls:o})},q.getTopURL=function(e,t,n){a(e,n,{url:t.tab?t.tab.url:""})},q.updateProxy=function(e,t,n){x(e,function(t){a(e,n,t)})},q.setZoom=function(e,t,n){var o=t.tab.id,r=e.zoomFactor*e.repeats;0==r?chrome.tabs.setZoom(o,1):chrome.tabs.getZoom(o,function(e){chrome.tabs.setZoom(o,e+r)})},q.removeURL=function(e,t,n){function o(){r++,r===i&&a(e,n,{response:"Done"})}var r=0,i=e.uid.length,s=e.uid;"string"==typeof e.uid&&(i=1,s=[e.uid]),s.forEach(function(e){k(e,o)})},q.localData=function(e,t,n){e.data.constructor===Object?(chrome.storage.local.set(e.data,function(){}),I.forEach(function(t){t.postMessage({action:"settingsUpdated",settings:e.data})})):chrome.storage.local.get(e.data,function(t){a(e,n,{data:t})})},q.captureVisibleTab=function(e,t,n){chrome.tabs.captureVisibleTab(null,{format:"png"},function(t){a(e,n,{dataUrl:t})})},q.getCaptureSize=function(e,t,n){var o=document.createElement("img");o.onload=function(){a(e,n,{width:o.width,height:o.height})},chrome.tabs.captureVisibleTab(null,{format:"png"},function(e){o.src=e})},q.deleteHistoryOlderThan=function(e,t,n){var o=e.days||0,r=e.hours||0;chrome.history.deleteRange({startTime:0,endTime:(new Date).getTime()-1e3*(86400*o+3600*r)},function(){})},q.removeBookmark=function(e,t,n){T(t.tab.url)},q.getBookmark=function(e,t,n){chrome.bookmarks.search({url:t.tab.url},function(t){a(e,n,{bookmarks:t})})},q.initGist=function(e,t,n){Gist.initGist(e.token,function(t){a(e,n,{gist:t})})},q.readComment=function(e,t,n){Gist.readComment(e.index,function(t){a(e,n,t)})},q.editComment=function(e,t,n){Gist.editComment(e.index,e.content,function(t){a(e,n,{gistResp:t})})};var H=[];q.queueURLs=function(e,t,n){H=H.concat(e.urls)},q.getQueueURLs=function(e,t,n){a(e,n,{queueURLs:H})},q.getVoices=function(e,t,n){chrome.tts.getVoices(function(t){a(e,n,{voices:t})})},q.read=function(e,t,n){var o=e.options||{};o.onEvent=function(t){a(e,n,{ttsEvent:t})},chrome.tts.speak(e.content,o)},q.stopReading=function(e,t,n){chrome.tts.stop()},q.openIncognito=function(e,t,n){chrome.windows.create({url:e.url,incognito:!0})};var D;return q.setUserAgent=function(e,t,n){e.userAgent?(D=e.userAgent,chrome.webRequest.onBeforeSendHeaders.addListener(O,{urls:["<all_urls>"]},["blocking","requestHeaders"])):chrome.webRequest.onBeforeSendHeaders.removeListener(O),chrome.tabs.reload(t.tab.id)},chrome.runtime.setUninstallURL("http://brookhong.github.io/2018/01/30/why-did-you-uninstall-surfingkeys.html"),q}();